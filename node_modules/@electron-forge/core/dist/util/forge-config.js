"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.setInitialForgeConfig = setInitialForgeConfig;
exports.fromBuildIdentifier = fromBuildIdentifier;
exports.forgeConfigIsValidFilePath = forgeConfigIsValidFilePath;
exports.renderConfigTemplate = renderConfigTemplate;
exports.default = void 0;

require("source-map-support/register");

var _fsExtra = _interopRequireDefault(require("fs-extra"));

var _path = _interopRequireDefault(require("path"));

var _lodash = require("lodash");

var _readPackageJson = require("./read-package-json");

var _pluginInterface = _interopRequireDefault(require("./plugin-interface"));

var _hook = require("./hook");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const underscoreCase = str => str.replace(/(.)([A-Z][a-z]+)/g, '$1_$2').replace(/([a-z0-9])([A-Z])/g, '$1_$2').toUpperCase(); // eslint-disable-next-line arrow-parens


const proxify = (buildIdentifier, object, envPrefix) => {
  let newObject = {};

  if (Array.isArray(object)) {
    newObject = [];
  }

  for (const [key, val] of Object.entries(object)) {
    if (typeof val === 'object' && key !== 'pluginInterface' && !(val instanceof RegExp)) {
      newObject[key] = proxify(buildIdentifier, object[key], `${envPrefix}_${underscoreCase(key)}`);
    } else {
      newObject[key] = object[key];
    }
  }

  return new Proxy(newObject, {
    get(target, name, receiver) {
      // eslint-disable-next-line no-prototype-builtins
      if (!target.hasOwnProperty(name) && typeof name === 'string') {
        const envValue = process.env[`${envPrefix}_${underscoreCase(name)}`];
        if (envValue) return envValue;
      }

      const value = Reflect.get(target, name, receiver); // eslint-disable-next-line no-underscore-dangle

      if (value && typeof value === 'object' && value.__isMagicBuildIdentifierMap) {
        const identifier = typeof buildIdentifier === 'function' ? buildIdentifier() : buildIdentifier;
        return value.map[identifier];
      }

      return value;
    },

    getOwnPropertyDescriptor(target, name) {
      const envValue = process.env[`${envPrefix}_${underscoreCase(name)}`]; // eslint-disable-next-line no-prototype-builtins

      if (target.hasOwnProperty(name)) {
        return Reflect.getOwnPropertyDescriptor(target, name);
      }

      if (envValue) {
        return {
          writable: true,
          enumerable: true,
          configurable: true,
          value: envValue
        };
      }

      return undefined;
    }

  });
};
/**
 * Sets sensible defaults for the `config.forge` object.
 */


function setInitialForgeConfig(packageJSON) {
  const {
    name = ''
  } = packageJSON;
  packageJSON.config.forge.makers[0].config.name = name.replace(/-/g, '_');
}

function fromBuildIdentifier(map) {
  return {
    map,
    __isMagicBuildIdentifierMap: true
  };
}

async function forgeConfigIsValidFilePath(dir, forgeConfig) {
  return typeof forgeConfig === 'string' && ((await _fsExtra.default.pathExists(_path.default.resolve(dir, forgeConfig))) || _fsExtra.default.pathExists(_path.default.resolve(dir, `${forgeConfig}.js`)));
}

function renderConfigTemplate(dir, templateObj, obj) {
  for (const [key, value] of Object.entries(obj)) {
    if (typeof value === 'object' && value !== null) {
      renderConfigTemplate(dir, templateObj, value);
    } else if (typeof value === 'string') {
      obj[key] = (0, _lodash.template)(value)(templateObj);

      if (obj[key].startsWith('require:')) {
        // eslint-disable-next-line global-require, import/no-dynamic-require
        obj[key] = require(_path.default.resolve(dir, obj[key].substr(8)));
      }
    }
  }
}

var _default = async dir => {
  const packageJSON = await (0, _readPackageJson.readRawPackageJson)(dir);
  let forgeConfig = packageJSON.config && packageJSON.config.forge ? packageJSON.config.forge : null;

  if (!forgeConfig) {
    if (await _fsExtra.default.pathExists(_path.default.resolve(dir, 'forge.config.js'))) {
      forgeConfig = 'forge.config.js';
    } else {
      forgeConfig = {};
    }
  }

  if (await forgeConfigIsValidFilePath(dir, forgeConfig)) {
    try {
      // eslint-disable-next-line global-require, import/no-dynamic-require
      forgeConfig = require(_path.default.resolve(dir, forgeConfig));
    } catch (err) {
      // eslint-disable-next-line no-console
      console.error(`Failed to load: ${_path.default.resolve(dir, forgeConfig)}`);
      throw err;
    }
  } else if (typeof forgeConfig !== 'object') {
    throw new Error('Expected packageJSON.config.forge to be an object or point to a requirable JS file');
  }

  const defaultForgeConfig = {
    electronRebuildConfig: {},
    packagerConfig: {},
    makers: [],
    publishers: [],
    plugins: []
  };
  forgeConfig = { ...defaultForgeConfig,
    ...forgeConfig
  };
  const templateObj = { ...packageJSON,
    year: new Date().getFullYear()
  };
  renderConfigTemplate(dir, templateObj, forgeConfig);
  forgeConfig.pluginInterface = new _pluginInterface.default(dir, forgeConfig);
  forgeConfig = await (0, _hook.runMutatingHook)(forgeConfig, 'resolveForgeConfig', forgeConfig);
  return proxify(forgeConfig.buildIdentifier || '', forgeConfig, 'ELECTRON_FORGE');
};

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlsL2ZvcmdlLWNvbmZpZy50cyJdLCJuYW1lcyI6WyJ1bmRlcnNjb3JlQ2FzZSIsInN0ciIsInJlcGxhY2UiLCJ0b1VwcGVyQ2FzZSIsInByb3hpZnkiLCJidWlsZElkZW50aWZpZXIiLCJvYmplY3QiLCJlbnZQcmVmaXgiLCJuZXdPYmplY3QiLCJBcnJheSIsImlzQXJyYXkiLCJrZXkiLCJ2YWwiLCJPYmplY3QiLCJlbnRyaWVzIiwiUmVnRXhwIiwiUHJveHkiLCJnZXQiLCJ0YXJnZXQiLCJuYW1lIiwicmVjZWl2ZXIiLCJoYXNPd25Qcm9wZXJ0eSIsImVudlZhbHVlIiwicHJvY2VzcyIsImVudiIsInZhbHVlIiwiUmVmbGVjdCIsIl9faXNNYWdpY0J1aWxkSWRlbnRpZmllck1hcCIsImlkZW50aWZpZXIiLCJtYXAiLCJnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IiLCJ3cml0YWJsZSIsImVudW1lcmFibGUiLCJjb25maWd1cmFibGUiLCJ1bmRlZmluZWQiLCJzZXRJbml0aWFsRm9yZ2VDb25maWciLCJwYWNrYWdlSlNPTiIsImNvbmZpZyIsImZvcmdlIiwibWFrZXJzIiwiZnJvbUJ1aWxkSWRlbnRpZmllciIsImZvcmdlQ29uZmlnSXNWYWxpZEZpbGVQYXRoIiwiZGlyIiwiZm9yZ2VDb25maWciLCJmcyIsInBhdGhFeGlzdHMiLCJwYXRoIiwicmVzb2x2ZSIsInJlbmRlckNvbmZpZ1RlbXBsYXRlIiwidGVtcGxhdGVPYmoiLCJvYmoiLCJzdGFydHNXaXRoIiwicmVxdWlyZSIsInN1YnN0ciIsImVyciIsImNvbnNvbGUiLCJlcnJvciIsIkVycm9yIiwiZGVmYXVsdEZvcmdlQ29uZmlnIiwiZWxlY3Ryb25SZWJ1aWxkQ29uZmlnIiwicGFja2FnZXJDb25maWciLCJwdWJsaXNoZXJzIiwicGx1Z2lucyIsInllYXIiLCJEYXRlIiwiZ2V0RnVsbFllYXIiLCJwbHVnaW5JbnRlcmZhY2UiLCJQbHVnaW5JbnRlcmZhY2UiXSwibWFwcGluZ3Mi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Q3RDLGVBQVosSUFBK0IsRUFBN0MsRUFBaURzQyxXQUFqRCxFQUE4RCxnQkFBOUQsQ0FBZDtBQUNELEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBGb3JnZUNvbmZpZyB9IGZyb20gJ0BlbGVjdHJvbi1mb3JnZS9zaGFyZWQtdHlwZXMnO1xuaW1wb3J0IGZzIGZyb20gJ2ZzLWV4dHJhJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgdGVtcGxhdGUgfSBmcm9tICdsb2Rhc2gnO1xuXG5pbXBvcnQgeyByZWFkUmF3UGFja2FnZUpzb24gfSBmcm9tICcuL3JlYWQtcGFja2FnZS1qc29uJztcbmltcG9ydCBQbHVnaW5JbnRlcmZhY2UgZnJvbSAnLi9wbHVnaW4taW50ZXJmYWNlJztcbmltcG9ydCB7IHJ1bk11dGF0aW5nSG9vayB9IGZyb20gJy4vaG9vayc7XG5cbmNvbnN0IHVuZGVyc2NvcmVDYXNlID0gKHN0cjogc3RyaW5nKSA9PiBzdHIucmVwbGFjZSgvKC4pKFtBLVpdW2Etel0rKS9nLCAnJDFfJDInKS5yZXBsYWNlKC8oW2EtejAtOV0pKFtBLVpdKS9nLCAnJDFfJDInKS50b1VwcGVyQ2FzZSgpO1xuXG4vLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgYXJyb3ctcGFyZW5zXG5jb25zdCBwcm94aWZ5ID0gPFQgZXh0ZW5kcyBvYmplY3Q+KFxuICBidWlsZElkZW50aWZpZXI6IHN0cmluZyB8ICgoKSA9PiBzdHJpbmcpLFxuICBvYmplY3Q6IFQsXG4gIGVudlByZWZpeDogc3RyaW5nLFxuKTogVCA9PiB7XG4gIGxldCBuZXdPYmplY3Q6IFQgPSB7fSBhcyBhbnk7XG4gIGlmIChBcnJheS5pc0FycmF5KG9iamVjdCkpIHtcbiAgICBuZXdPYmplY3QgPSBbXSBhcyBhbnk7XG4gIH1cblxuICBmb3IgKGNvbnN0IFtrZXksIHZhbF0gb2YgT2JqZWN0LmVudHJpZXMob2JqZWN0KSkge1xuICAgIGlmICh0eXBlb2YgdmFsID09PSAnb2JqZWN0JyAmJiBrZXkgIT09ICdwbHVnaW5JbnRlcmZhY2UnICYmICEodmFsIGluc3RhbmNlb2YgUmVnRXhwKSkge1xuICAgICAgKG5ld09iamVjdCBhcyBhbnkpW2tleV0gPSBwcm94aWZ5KGJ1aWxkSWRlbnRpZmllciwgKG9iamVjdCBhcyBhbnkpW2tleV0sIGAke2VudlByZWZpeH1fJHt1bmRlcnNjb3JlQ2FzZShrZXkpfWApO1xuICAgIH0gZWxzZSB7XG4gICAgICAobmV3T2JqZWN0IGFzIGFueSlba2V5XSA9IChvYmplY3QgYXMgYW55KVtrZXldO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBuZXcgUHJveHk8VD4obmV3T2JqZWN0LCB7XG4gICAgZ2V0KHRhcmdldCwgbmFtZSwgcmVjZWl2ZXIpIHtcbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1wcm90b3R5cGUtYnVpbHRpbnNcbiAgICAgIGlmICghdGFyZ2V0Lmhhc093blByb3BlcnR5KG5hbWUpICYmIHR5cGVvZiBuYW1lID09PSAnc3RyaW5nJykge1xuICAgICAgICBjb25zdCBlbnZWYWx1ZSA9IHByb2Nlc3MuZW52W2Ake2VudlByZWZpeH1fJHt1bmRlcnNjb3JlQ2FzZShuYW1lKX1gXTtcbiAgICAgICAgaWYgKGVudlZhbHVlKSByZXR1cm4gZW52VmFsdWU7XG4gICAgICB9XG4gICAgICBjb25zdCB2YWx1ZSA9IFJlZmxlY3QuZ2V0KHRhcmdldCwgbmFtZSwgcmVjZWl2ZXIpO1xuXG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdW5kZXJzY29yZS1kYW5nbGVcbiAgICAgIGlmICh2YWx1ZSAmJiB0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnICYmIHZhbHVlLl9faXNNYWdpY0J1aWxkSWRlbnRpZmllck1hcCkge1xuICAgICAgICBjb25zdCBpZGVudGlmaWVyID0gdHlwZW9mIGJ1aWxkSWRlbnRpZmllciA9PT0gJ2Z1bmN0aW9uJyA/IGJ1aWxkSWRlbnRpZmllcigpIDogYnVpbGRJZGVudGlmaWVyO1xuICAgICAgICByZXR1cm4gdmFsdWUubWFwW2lkZW50aWZpZXJdO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH0sXG4gICAgZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHRhcmdldCwgbmFtZSkge1xuICAgICAgY29uc3QgZW52VmFsdWUgPSBwcm9jZXNzLmVudltgJHtlbnZQcmVmaXh9XyR7dW5kZXJzY29yZUNhc2UobmFtZSBhcyBzdHJpbmcpfWBdO1xuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXByb3RvdHlwZS1idWlsdGluc1xuICAgICAgaWYgKHRhcmdldC5oYXNPd25Qcm9wZXJ0eShuYW1lKSkge1xuICAgICAgICByZXR1cm4gUmVmbGVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodGFyZ2V0LCBuYW1lKTtcbiAgICAgIH1cblxuICAgICAgaWYgKGVudlZhbHVlKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgd3JpdGFibGU6IHRydWUsXG4gICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSxcbiAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsXG4gICAgICAgICAgdmFsdWU6IGVudlZhbHVlLFxuICAgICAgICB9O1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH0sXG4gIH0pO1xufTtcblxuLyoqXG4gKiBTZXRzIHNlbnNpYmxlIGRlZmF1bHRzIGZvciB0aGUgYGNvbmZpZy5mb3JnZWAgb2JqZWN0LlxuICovXG5leHBvcnQgZnVuY3Rpb24gc2V0SW5pdGlhbEZvcmdlQ29uZmlnKHBhY2thZ2VKU09OOiBhbnkpIHtcbiAgY29uc3QgeyBuYW1lID0gJycgfSA9IHBhY2thZ2VKU09OO1xuXG4gIHBhY2thZ2VKU09OLmNvbmZpZy5mb3JnZS5tYWtlcnNbMF0uY29uZmlnLm5hbWUgPSBuYW1lLnJlcGxhY2UoLy0vZywgJ18nKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGZyb21CdWlsZElkZW50aWZpZXI8VD4obWFwOiB7IFtrZXk6IHN0cmluZ106IFQgfCB1bmRlZmluZWQgfSkge1xuICByZXR1cm4ge1xuICAgIG1hcCxcbiAgICBfX2lzTWFnaWNCdWlsZElkZW50aWZpZXJNYXA6IHRydWUsXG4gIH07XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBmb3JnZUNvbmZpZ0lzVmFsaWRGaWxlUGF0aChkaXI6IHN0cmluZywgZm9yZ2VDb25maWc6IHN0cmluZyB8IEZvcmdlQ29uZmlnKSB7XG4gIHJldHVybiB0eXBlb2YgZm9yZ2VDb25maWcgPT09ICdzdHJpbmcnXG4gICAgJiYgKFxuICAgICAgYXdhaXQgZnMucGF0aEV4aXN0cyhwYXRoLnJlc29sdmUoZGlyLCBmb3JnZUNvbmZpZykpXG4gICAgICB8fCBmcy5wYXRoRXhpc3RzKHBhdGgucmVzb2x2ZShkaXIsIGAke2ZvcmdlQ29uZmlnfS5qc2ApKVxuICAgICk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZW5kZXJDb25maWdUZW1wbGF0ZShkaXI6IHN0cmluZywgdGVtcGxhdGVPYmo6IGFueSwgb2JqOiBhbnkpIHtcbiAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXMob2JqKSkge1xuICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnICYmIHZhbHVlICE9PSBudWxsKSB7XG4gICAgICByZW5kZXJDb25maWdUZW1wbGF0ZShkaXIsIHRlbXBsYXRlT2JqLCB2YWx1ZSk7XG4gICAgfSBlbHNlIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnKSB7XG4gICAgICBvYmpba2V5XSA9IHRlbXBsYXRlKHZhbHVlKSh0ZW1wbGF0ZU9iaik7XG4gICAgICBpZiAob2JqW2tleV0uc3RhcnRzV2l0aCgncmVxdWlyZTonKSkge1xuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgZ2xvYmFsLXJlcXVpcmUsIGltcG9ydC9uby1keW5hbWljLXJlcXVpcmVcbiAgICAgICAgb2JqW2tleV0gPSByZXF1aXJlKHBhdGgucmVzb2x2ZShkaXIsIG9ialtrZXldLnN1YnN0cig4KSkpO1xuICAgICAgfVxuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBhc3luYyAoZGlyOiBzdHJpbmcpID0+IHtcbiAgY29uc3QgcGFja2FnZUpTT04gPSBhd2FpdCByZWFkUmF3UGFja2FnZUpzb24oZGlyKTtcbiAgbGV0IGZvcmdlQ29uZmlnOiBGb3JnZUNvbmZpZyB8IHN0cmluZyB8IG51bGwgPSAocGFja2FnZUpTT04uY29uZmlnICYmIHBhY2thZ2VKU09OLmNvbmZpZy5mb3JnZSlcbiAgICA/IHBhY2thZ2VKU09OLmNvbmZpZy5mb3JnZVxuICAgIDogbnVsbDtcblxuICBpZiAoIWZvcmdlQ29uZmlnKSB7XG4gICAgaWYgKGF3YWl0IGZzLnBhdGhFeGlzdHMocGF0aC5yZXNvbHZlKGRpciwgJ2ZvcmdlLmNvbmZpZy5qcycpKSkge1xuICAgICAgZm9yZ2VDb25maWcgPSAnZm9yZ2UuY29uZmlnLmpzJztcbiAgICB9IGVsc2Uge1xuICAgICAgZm9yZ2VDb25maWcgPSB7fSBhcyBhbnkgYXMgRm9yZ2VDb25maWc7XG4gICAgfVxuICB9XG5cbiAgaWYgKGF3YWl0IGZvcmdlQ29uZmlnSXNWYWxpZEZpbGVQYXRoKGRpciwgZm9yZ2VDb25maWcpKSB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBnbG9iYWwtcmVxdWlyZSwgaW1wb3J0L25vLWR5bmFtaWMtcmVxdWlyZVxuICAgICAgZm9yZ2VDb25maWcgPSByZXF1aXJlKHBhdGgucmVzb2x2ZShkaXIsIGZvcmdlQ29uZmlnIGFzIHN0cmluZykpIGFzIEZvcmdlQ29uZmlnO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWNvbnNvbGVcbiAgICAgIGNvbnNvbGUuZXJyb3IoYEZhaWxlZCB0byBsb2FkOiAke3BhdGgucmVzb2x2ZShkaXIsIGZvcmdlQ29uZmlnIGFzIHN0cmluZyl9YCk7XG4gICAgICB0aHJvdyBlcnI7XG4gICAgfVxuICB9IGVsc2UgaWYgKHR5cGVvZiBmb3JnZUNvbmZpZyAhPT0gJ29iamVjdCcpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0V4cGVjdGVkIHBhY2thZ2VKU09OLmNvbmZpZy5mb3JnZSB0byBiZSBhbiBvYmplY3Qgb3IgcG9pbnQgdG8gYSByZXF1aXJhYmxlIEpTIGZpbGUnKTtcbiAgfVxuICBjb25zdCBkZWZhdWx0Rm9yZ2VDb25maWcgPSB7XG4gICAgZWxlY3Ryb25SZWJ1aWxkQ29uZmlnOiB7fSxcbiAgICBwYWNrYWdlckNvbmZpZzoge30sXG4gICAgbWFrZXJzOiBbXSxcbiAgICBwdWJsaXNoZXJzOiBbXSxcbiAgICBwbHVnaW5zOiBbXSxcbiAgfTtcbiAgZm9yZ2VDb25maWcgPSB7XG4gICAgLi4uZGVmYXVsdEZvcmdlQ29uZmlnLFxuICAgIC4uLmZvcmdlQ29uZmlnLFxuICB9O1xuXG4gIGNvbnN0IHRlbXBsYXRlT2JqID0geyAuLi5wYWNrYWdlSlNPTiwgeWVhcjogKG5ldyBEYXRlKCkpLmdldEZ1bGxZZWFyKCkgfTtcbiAgcmVuZGVyQ29uZmlnVGVtcGxhdGUoZGlyLCB0ZW1wbGF0ZU9iaiwgZm9yZ2VDb25maWcpO1xuXG4gIGZvcmdlQ29uZmlnLnBsdWdpbkludGVyZmFjZSA9IG5ldyBQbHVnaW5JbnRlcmZhY2UoZGlyLCBmb3JnZUNvbmZpZyk7XG5cbiAgZm9yZ2VDb25maWcgPSBhd2FpdCBydW5NdXRhdGluZ0hvb2soZm9yZ2VDb25maWcsICdyZXNvbHZlRm9yZ2VDb25maWcnLCBmb3JnZUNvbmZpZyk7XG5cbiAgcmV0dXJuIHByb3hpZnk8Rm9yZ2VDb25maWc+KGZvcmdlQ29uZmlnLmJ1aWxkSWRlbnRpZmllciB8fCAnJywgZm9yZ2VDb25maWcsICdFTEVDVFJPTl9GT1JHRScpO1xufTtcbiJdfQ==